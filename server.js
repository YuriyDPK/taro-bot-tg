const TelegramBot = require("node-telegram-bot-api");
const express = require("express");

// Ð¢Ð²Ð¾Ð¹ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°
const TOKEN = "7725904251:AAFueiMnzNrF9DzomOXSLdUECR5nVa8IAhQ";
// Ð¢Ð²Ð¾Ð¹ ÑÐ°Ð¹Ñ‚ (Ñ HTTPS)
const WEB_APP_URL = "https://ashat-taro.ru";

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð¾Ñ‚Ð° Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ long polling
const bot = new TelegramBot(TOKEN, { polling: true });

// Express ÑÐµÑ€Ð²ÐµÑ€
const app = express();
const PORT = process.env.PORT || 3001;

// Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°
bot.setMyCommands([
  {
    command: "start",
    description: "ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼",
  },
  {
    command: "menu",
    description: "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼ÐµÐ½ÑŽ",
  },
  {
    command: "help",
    description: "ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ",
  },
]);

// Ð•ÑÐ»Ð¸ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ POST Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¾Ñ‚ WebApp
app.use(express.json());

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñ‹ Ð¼ÐµÐ½ÑŽ
const getMainKeyboard = () => {
  return {
    keyboard: [
      [{ text: "ðŸš€ ÐÐ°Ñ‡Ð°Ñ‚ÑŒ" }, { text: "ðŸ“± ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ" }],
      [{ text: "ðŸ“‹ ÐœÐµÐ½ÑŽ" }, { text: "â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ" }],
    ],
    resize_keyboard: true,
    one_time_keyboard: false,
  };
};

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.onText(/\/start(.*)/, (msg, match) => {
  const chatId = msg.chat.id;

  // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ Ð¸Ð· ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
  const startParam = match[1].trim(); // ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ Ð¿Ð¾ÑÐ»Ðµ /start

  // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ URL Ð´Ð»Ñ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
  let url = WEB_APP_URL; // Ð”ÐµÑ„Ð¾Ð»Ñ‚Ð½Ñ‹Ð¹ URL

  // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€, Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐµÐ³Ð¾ Ðº URL
  if (startParam) {
    // ÐŸÑ€Ð¸Ð¼ÐµÑ€: ÐµÑÐ»Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ "sign-in", Ñ‚Ð¾ ÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ð¹ URL Ð±ÑƒÐ´ÐµÑ‚ "https://calm-peas-invent.loca.lt/sign-in"
    url = `${WEB_APP_URL}/${startParam}`; // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ð¹ URL
  } else {
    // Ð•ÑÐ»Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð° Ð½ÐµÑ‚, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ URL
    url = WEB_APP_URL; // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ URL
  }

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ð¾Ð¹
  bot.sendMessage(chatId, "ðŸŽ‰ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ! Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:", {
    reply_markup: getMainKeyboard(),
  });

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
  bot.sendMessage(chatId, "ÐžÑ‚ÐºÑ€Ð¾Ð¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹", {
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: "ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ",
            web_app: { url: url },
          },
        ],
      ],
    },
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /menu
bot.onText(/\/menu/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, "ðŸ“‹ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ:", {
    reply_markup: getMainKeyboard(),
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  const helpText = `
â“ *ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð¿Ð¾ Ð±Ð¾Ñ‚Ñƒ*

Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼
/menu - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
/help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ

ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð¼ÐµÐ½ÑŽ:
ðŸš€ ÐÐ°Ñ‡Ð°Ñ‚ÑŒ - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
ðŸ“± ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ - ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
ðŸ“‹ ÐœÐµÐ½ÑŽ - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ - ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ
  `;

  bot.sendMessage(chatId, helpText, {
    parse_mode: "Markdown",
    reply_markup: getMainKeyboard(),
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (ÐºÐ½Ð¾Ð¿Ð¾Ðº)
bot.on("message", (msg) => {
  if (msg?.web_app_data?.data) {
    const data = JSON.parse(msg.web_app_data.data);
    bot.sendMessage(msg.chat.id, `Ð¢Ñ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ð» Ð´Ð°Ð½Ð½Ñ‹Ðµ: ${JSON.stringify(data)}`);
    return;
  }

  const chatId = msg.chat.id;
  const text = msg.text;

  switch (text) {
    case "ðŸš€ ÐÐ°Ñ‡Ð°Ñ‚ÑŒ":
      // Ð­Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /start
      bot.sendMessage(chatId, "ÐžÑ‚ÐºÑ€Ð¾Ð¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹", {
        reply_markup: {
          inline_keyboard: [
            [
              {
                text: "ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ",
                web_app: { url: WEB_APP_URL },
              },
            ],
          ],
        },
      });
      break;

    case "ðŸ“± ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ":
      bot.sendMessage(chatId, "ÐžÑ‚ÐºÑ€Ð¾Ð¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹", {
        reply_markup: {
          inline_keyboard: [
            [
              {
                text: "ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ",
                web_app: { url: WEB_APP_URL },
              },
            ],
          ],
        },
      });
      break;

    case "ðŸ“‹ ÐœÐµÐ½ÑŽ":
      bot.sendMessage(chatId, "ðŸ“‹ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ:", {
        reply_markup: getMainKeyboard(),
      });
      break;

    case "â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ":
      const helpText = `
â“ *ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð¿Ð¾ Ð±Ð¾Ñ‚Ñƒ*

Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼
/menu - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
/help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ

ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð¼ÐµÐ½ÑŽ:
ðŸš€ ÐÐ°Ñ‡Ð°Ñ‚ÑŒ - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
ðŸ“± ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ - ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
ðŸ“‹ ÐœÐµÐ½ÑŽ - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ - ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ
      `;

      bot.sendMessage(chatId, helpText, {
        parse_mode: "Markdown",
        reply_markup: getMainKeyboard(),
      });
      break;
  }
});

// ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ endpoint Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°
app.get("/", (req, res) => {
  res.send("Server is running");
});

app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});
